# 2026-01-30 工作日誌

## 本日工作重點
完成 **SynthBlockly Stage** 與 **SynthBlockly (Web)** 在演奏邏輯與時序系統上的關鍵對齊。透過 Java 執行緒 (Thread) 技術，解決了 Processing 在複雜編曲下的非阻塞演奏問題。

### 1. 旋律解析與非阻塞演奏 (Melody Engine)
- **積木實作**：新增 `sb_play_melody` 積木，支援解析 `C4Q, E4Q, G4H` 等標準音樂字串。
- **Java 核心強化**：
    - 注入 `MelodyPlayer` (Thread) 類別，能在背景解析字串並進行精確計時。
    - 注入 `noteToMidi` 輔助函式，支援將 A-G 音名轉換為 MIDI 鍵號。
    - 實作 `playNoteForDuration`，讓執行緒能發出「演奏固定時值」的指令後繼續處理下一個音符。

### 2. 節奏與音序系統 (Rhythm & Sequencer)
- **積木實作**：新增 `sb_rhythm_sequence` 積木，支援 `x---x---` 16 格節奏樣式。
- **資源預載**：強化 `sb_minim_init`，自動嘗試載入 `kick.wav` 與 `snare.wav` 並定義全域 Sampler 變數，確保節奏積木即放即用。
- **時序對齊**：支援透過 `measure` 參數設定小節位移，方便進行多音軌同步。

### 3. 全域時序系統 (Transport System)
- **BPM 控制**：新增 `sb_transport_set_bpm`，所有時值換算皆與全域 `bpm` 變數連動。
- **音樂循環 (Music Loop)**：
    - 實作 `sb_tone_loop` 帽子積木。
    - 採用 Java 執行緒實現非阻塞循環，支援以音樂時值（如 `1m`, `4n`）為週期的重複執行。
    - 解決了 Processing 預設 `draw()` 幀數限制問題，讓音樂演奏更穩定。

### 4. 語系與規格對齊
- 完成 `media/zh-hant.js` 翻譯更新，確保 UI 顯示一致。
- 所有積木 ID 完全遵循 `spec.md` 規範，達成 XML 互通標準。

## 下一步計畫
- 繼續更新剩餘舊範例的 XML（特別是 Serial 相關範例）。
- 實作 Serial.write 以支援從超級舞台反向控制 Arduino。
- 測試多執行緒在高併發（多個 Loop 同時執行）下的穩定性。
