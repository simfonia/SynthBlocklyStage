# 2026-01-10 工作日誌

## 任務：重構超級舞台介面、升級音訊架構與實作雙層日誌系統

### 1. 視覺區塊與佈局 (Super Stage)
- **垂直分割與控制面板**：
    - 視窗高度擴充 (UserH + 250px)，下方 250px 作為固定控制面板。
    - 實作動態寬度計算：`currentVisualW` 隨 `showLog` 開關切換（開啟時固定左側 W，關閉時填滿全寬）。
    - 三大視圖 (Waveform, ADSR, Spectrum) 根據啟用數量自動均分寬度。
    - 消除視覺區周圍殘留的細紅線 (noStroke 處理)。
- **UI 佈局優化**：
    - 調整開關順序為：WAVE, ADSR, SPEC, LOG (加大間距至 70px)。
    - 滑桿垂直堆疊：TRAIL, SCALE, FG COLOR (彩虹滑桿)。
    - ADSR 與 GAIN 控制組：右移至 X=320，標籤置於下方 (BOTTOM_OUTSIDE)，間距加寬。

### 2. 音訊系統 (UGen Sampler & Synth)
- **架構遷移**：將 `AudioSample` 全面替換為 `Sampler` UGen，解決無法 Patch 到 Output 的限制。
- **合成器發聲連動**：
    - 新增 `audio_play_note` (Note On) 與 `audio_stop_note` (Note Off) 積木。
    - 使用 `HashMap<Integer, ADSR> activeNotes` 管理多音並行發聲。
    - 實作 `unpatchAfterRelease(out)` 確保音符結束後自動釋放資源。
- **MIDI 深度串接**：新增 `midi_off_note` 積木，完美對接硬體琴鍵放開事件。

### 3. ADSR 視覺化強化
- **狀態機移動**：引入 `adsrState` 與 `adsrTimer`，讓光點精確沿著包絡線軌跡 (A -> D -> S -> R) 移動。
- **Sustain 動態**：當處於 Sustain 階段時，光點會自動在 S 區段內水平脈動滑動。
- **霓虹光暈**：使用多層透明疊加繪製光點，增強表演視覺效果。

### 4. 日誌系統 (Log System)
- **雙層 Textarea 結構**：
    - 上區 (ALERTS)：深紅背景，顯示 Warning 與 Error。
    - 下區 (CONSOLE)：深黑背景，顯示 Info 與 Important。
- **功能特性**：
    - 改用 ControlP5 `Textarea` 組件，支援原生捲軸。
    - 垂直捲軸加寬至 30px 方便觸控/滑鼠操作。
    - 支援由下往上自動捲動，最大保留 100 行訊息。
    - 同步 MIDI Note ON/OFF 訊息至系統日誌。

### 5. VS Code 擴充功能核心
- **狀態管理**：在 `context.globalState` 中儲存 `lastPath`，實現專案開啟/儲存路徑記憶。
- **型別修復**：修正 `Textarea` 強制轉型錯誤及語法轉義問題。

### 6. 在地化與範例
- **語系同步**：補齊 `en.js` 與 `zh-hant.js` 所有新功能鍵值。
- **範例更新**：重寫 `drum.xml`，實作 57/59 鼓組與 60+ 合成器的 Note On/Off 完整邏輯。
