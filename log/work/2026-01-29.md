# 2026-01-29 工作日誌

## 本日工作重點
完成 **SynthBlockly Stage** 的基礎架構標準化與資源管理系統重構，解決了 Windows 檔案鎖定衝突，並對齊了積木命名規範。

### 1. 基礎建設標準化 (Core Infrastructure)
- **XML 格式優化**：將 XML 序列化從 `domToText` 改為 `domToPrettyText`，確保存檔檔案具備縮排且易於閱讀。
- **持久化功能 (Persistence)**：實作了 `lastXmlPath` 記憶功能。現在 VS Code 會記住最後一次開啟的專案，並在 Webview 啟動時自動恢復。
- **API 相容性 (Polyfill)**：為 `Blockly.Workspace` 加入 Polyfill，將棄用的變數存取方法導向 `getVariableMap()`，消除 Console 警告並支援未來版本。

### 2. 積木 ID 與命名對齊 (Spec Alignment)
- **全面更名**：依據規格書，將 Audio 類積木 ID 由 `audio_` 前綴改為 `sb_` 前綴（如 `sb_minim_init`, `sb_play_note`）。
- **產生器強化**：採用「強效註冊」模式，確保產生器函式同時註冊於 `forBlock` 與產生器物件本身，解決了執行期找不到產生器的 Error。
- **動態功能修復**：將 `audio.js` 改回 JavaScript 定義模式，實作 Mutator 以支持 `sb_create_harmonic_synth` 等積木的動態欄位增減。

### 3. 原生執行與資源管理 (Resource Management)
- **執行前強制存檔**：為了確保路徑可控，實作了執行新專案前必須先存檔的流程。
- **名稱清理器 (Sanitizer)**：實作 `_sanitizeProjectName`，自動將包含空格、點號或特殊字元的名稱轉換為符合 Processing/Java 規範的合法識別碼。
- **原生路徑執行**：徹底捨棄 Windows `Temp` 資料夾依賴。現在 Processing 直接在專案資料夾下執行，滿足 `Folder Name == PDE Name` 的硬性要求。
- **智慧資源合併**：
    - **專案優先**：優先讀取專案下的 `data/` 資料夾資源。
    - **內建自動掛載**：自動將擴充功能內建的 `media/samples/` 子目錄以 Junction 方式連結至專案 `data/` 下（僅當不衝突時），達成「內建+自訂」資源無縫整合。

### 4. 範例修正
- 已完成 `synth_showcase`, `instrument_test`, `drum`, `test` 等範例的 ID 更新與路徑驗證，確保在新的原生架構下皆能正常執行並發聲。

## 下一步計畫
- 繼續修正剩餘的 Serial 相關範例（如 `08_Serial_KICK`）。
- 實作 Stage 版專屬的互動積木（如「隨音量變化的視覺」）。
