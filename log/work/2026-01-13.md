# 2026-01-13 工作日誌 (SynthBlockly Stage)

## 本次任務重點
- 實作按鍵衝突視覺回饋 (Glow + Dynamic Text)。
- 將按鍵事件積木帽子化 (Hat Block)。
- 修正獨立事件積木的代碼注入機制。

## 詳細更動
### 1. 按鍵衝突視覺強化 (Plan A Plus)
- **檔案**: `media/main.js`, `media/style.css`, `media/blocks/ui.js`
- **內容**:
    - 在 `ui_key_event` 積木新增 `CONFLICT_LABEL` 欄位。
    - 當 `checkKeyConflicts` 偵測到衝突時，動態設定標題文字為 `[！已被舞台鋼琴佔用]` 或 `[！按鍵衝突]`。
    - 使用 CSS `filter: drop-shadow` 實作金黃色外發光效果 (`blockly-conflict-glow`)。
    - 啟用 `Blockly.inject` 的 `disable: true` 設定，確保 `setDisabled(true)` 能產生正確的變灰效果。

### 2. 積木架構優化
- **檔案**: `media/blocks/ui.js`, `media/main.js`
- **內容**:
    - 移除 `ui_key_event` 的上下銜接點，轉為獨立頂層帽子積木。
    - 修改 `generateAndSendCode` 邏輯，改為遍歷 `workspace.getTopBlocks()` 並對每個積木呼叫 `blockToCode`，確保孤立的事件積木代碼能被存入暫存器。

### 3. 程式產生器修正 (Audio Core & Key Events)
- **檔案**: `media/generators/ui.js`, `media/generators/_core.js`
- **內容**:
    - `ui_key_event` 產生器現在會主動檢查並注入 `void keyPressed()` 框架（若舞台積木不存在時）。
    - 修正 `_core.js` 的 `finish()` 邏輯，確保鍵盤事件佔位符替換後的字串被正確存入輸出。
    - 統一按鍵變數名稱為 `k` (toLowerCase)，解決 Java 代碼中的變數參考錯誤。
    - 在 `init()` 中重設 `keyEvents_` 陣列，避免重複產生代碼。

## 測試結果
- [x] 按下 Q 鍵能正確觸發 Kick 取樣音效。
- [x] 加入舞台積木後，Q 鍵積木自動發光、標題出現「已被舞台鋼琴佔用」並變灰失效。
- [x] 移除舞台積木後，Q 鍵積木自動恢復正常。
- [x] 事件積木獨立放置時（不串接 setup）代碼產生依然正確。
