# 2026-02-04 工作日誌

## 1. 範例載入系統實作
- **工具列更新**：在「開新檔案」後方新增「範例」按鈕。
- **原生選單整合**：捨棄 Webview 下拉選單（解決遮擋問題），改用 VS Code 原生 `showQuickPick` 介面。
- **自動掃描**：後端實作自動掃描 `examples/` 資料夾功能，並支援包含與資料夾同名 XML 的專案。
- **保護機制**：範例載入後自動標記為唯讀狀態，並禁用自動儲存功能以保護原始範例。

## 2. 步進音序器 (Step Sequencer) 強化
- **智慧 Tokenizer**：修復 Java 產生器邏輯，從純字元切割升級為語法解析器。現在可正確識別 `Dm7...` 或 `C#4-` 等混用字串，不再將和弦名稱拆散。
- **模式選單優化**：將選單名稱由「音名/和弦」簡化為「和弦」，並在「單音/打擊」模式下支援 X (觸發) 與音名 (如 C4)。
- **語系同步**：將選單文字與 Tooltip 移至 `zh-hant.js` 與 `en.js` 統一管理。

## 3. 音訊引擎架構重構 (核心修復)
- **複合 Key 機制**：為了解決多執行緒環境下的樂器錯亂，將 `activeNotes` 的 Key 由單純音高改為 `instrumentName_pitch` 字串。
- **並發安全性**：將 `activeNotes` 提升為 `ConcurrentHashMap`，徹底解決背景序列與即時按鍵衝突時可能產生的 Java Exception。
- **鍵盤記憶功能**：在 `visual.js` 中將按鍵狀態改為 `HashMap<Integer, String>`，記住按下時使用的樂器，確保 Release 時能正確關閉聲音，即使中途切換樂器也不會造成長鳴音 (Stuck Note)。
- **簽章更新**：全面更新 `playNoteInternal` 等 5 個核心 Java 方法及相關 Generator 以支援參數傳遞。

## 4. 預備拍 (Count-in) 積木升級
- **自訂拍號**：新增分子與分母欄位，支援 3/4, 6/8 等非 4/4 拍號。
- **動態計算**：實作 `beatDelay = (60000 / bpm) * (4 / beatUnit)` 公式，確保預備拍速度與音樂同步。
- **介面精簡**：加入 `inputsInline: true` 讓積木呈現單行排列。

## 5. 文件與其他
- **README 中文化**：全文重寫為正體中文，並聚焦於環境架構、核心特色與快速上手流程。
- **Bug 修復**：修正了 `visual_stage_setup` 中遺漏的參數傳遞導致的編譯錯誤。
