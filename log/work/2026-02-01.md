# 2026-02-01 工作日誌

## 本日工作重點
大幅強化了旋律解析引擎，實現了網頁版與桌面版的功能同步（並在部分功能上超越），同時建立了完整的說明文件體系與多語系支援。

### 1. 旋律引擎深度進化 (關鍵更新)
- **支援連結線 (Tie, `+`)**：實作了時值累加邏輯（如 `C4H.+E` 代表三拍半）。此功能已同步至 **#SynthBlockly (網頁版)** 核心。
- **實作排隊播放機制**：在 Java 端引入 `melodyLock` (執行緒鎖定)，現在連續放置多個旋律積木會「一段接一段」播放，不再重疊。
- **解析器強化**：支援附點音符 (`.`) 與三連音 (`_T`)，並優化了多行字串與換行符的解析穩定性。
- **升級為「旋律清單」**：將原本的單行輸入改為 `field_multilinetext` 多行編輯，並整合了動態樂器下拉選單。

### 2. 核心架構修復與優化
- **樂器順序對齊**：將 Java 端的 `HashMap` 更換為 `LinkedHashMap`，確保舞台切換樂器的順序與積木排列順序一致。
- **移除預設樂器**：清理了 `sb_minim_init` 中的硬編碼 `default` 樂器，使音源完全由使用者自訂。
- **ADSR 視覺修正**：修復了 `Sustain=0` 或 `Sustain=1` 時包絡線座標計算錯誤導致的突起或下凹問題。
- **波形衝突修復**：修正了 `sb_instrument_container` 的產生器邏輯，確保內部波形設定不被預設值覆蓋。

### 3. 教學系統與 UI 升級
- **全面語系化 (i18n)**：將所有剩餘的硬編碼中文積木（UI, Visual, MIDI）移至 `zh-hant.js`，並同步建立 `en.js` 翻譯。
- **動態說明文件系統**：
    - 在 `main.js` 實作了語言感應攔截，會根據介面語言自動開啟 `_zh-hant.html` 或 `_en.html`。
    - 建立了 5 份核心說明文件，並完成 **色彩同步**（文件主題色 = 積木分類色）。
    - 在所有具備說明的積木 Tooltip 中加入引導字串：`按右鍵選擇「說明」了解更多用法。`
- **新增輔助積木**：`結束程式` (exit)、`等待` (delay) 以及 `是否有旋律在播放？` (狀態偵測)。

### 4. 跨專案同步
- 將桌面版開發出的 `+` 連結線解析邏輯回流至 `#SynthBlockly`，並同步更新了網頁版的說明文件。

## 待辦事項
- [ ] 測試長篇旋律清單在排隊播放時的記憶體佔用。
- [ ] 考慮加入「當旋律播完時」的事件帽積木（目前需用 `if` 偵測）。
- [ ] 撰寫更多關於加法合成的範例教學。
