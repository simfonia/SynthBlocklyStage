# 2026-01-11 工作日誌

## 任務：優化合成器音高系統、實作 PC 鍵盤表演與 MIDI 動態管理

### 1. 介面與日誌系統修復 (UI Fixes)
- **Log 開關修復**：修正 `showLog` 開關失效問題。原因在於 `Textarea` 在 ControlP5 中不屬於標準 `Controller`，需改用 `cp5.get(Textarea.class, "...")` 存取才能正確執行 `.show()` 與 `.hide()`。
- **捲軸錯誤修正**：移除無效的 `.getScrollbar().setWidth()` 呼叫，解決編譯錯誤。
- **訊息分類強化**：重構 `logToScreen` 邏輯。
    - **上層面板 (alertsArea)**：顯示重要 (!)、警告 (WARN)、錯誤 (ERR) 訊息。
    - **下層面板 (consoleArea)**：顯示一般 (INFO) 訊息。
- **UI 對齊優化**：透過 `setMarginTop(4)` 與 `toUpperCase(false)` 解決了 `ScrollableList` 選取文字與按鈕文字垂直偏移的問題。

### 2. 音訊合成器升級 (Synth Refactor)
- **音高系統實作**：
    - 新增 `mtof(float note)` 輔助函式，支援將 MIDI Note 轉換為精確頻率。
    - 加入全域移調變數 `pitchTranspose`，預留未來擴充性。
    - 更新 `audio_play_note` 積木，參數簡化為「音高 (Pitch)」與「力度 (Velocity)」。
- **低音表現優化**：
    - 將預設波形由正弦波 (SINE) 改為 **三角波 (TRIANGLE)**，顯著提升低頻音域的泛音聽感。
    - 提升預設振幅 (Amplitude) 至 `0.6f` ~ `0.8f`，並將 `masterGain` 預設值調高至 `-5.0`。

### 3. PC 鍵盤演奏功能 (Keyboard Controller)
- **全自動映射**：在舞台初始化時自動注入 `keyPressed` 與 `keyReleased` 邏輯。
- **按鍵對應**：參考 SynthBlockly 映射 Q-U (C4-B4) 與 I-\ (C5-A5)，包含半音階。
- **即時移調控制**：
    - `Arrow Up/Down`：調整八度 (±12 半音)。
    - `+/-` (主鍵盤與數字鍵盤)：微調半音。
    - `Backspace`：重設移調。
- **視覺連動**：PC 鍵盤彈奏現在能完美觸發 ADSR 光點動畫與波形跳動。

### 4. MIDI 裝置動態管理
- **動態選擇選單**：新增 `ScrollableList` UI，即時列出系統 MIDI 輸入裝置。
- **手動掃描 (SCAN)**：新增 SCAN 按鈕，配合 `scanMidi()` 邏輯解決 Windows 環境下 Java MIDI 熱插拔偵測限制。
- **啟動自動化**：程式啟動時自動偵測並選取第一個可用裝置，並在控制台列印詳細偵測報告。

### 5. 範例更新
- **drum.xml**：更新範例檔案，使其符合新版 `audio_play_note` 的音高與力度參數結構。
