## 2026-02-08 工作紀錄
### 音訊演奏與即時觸發優化 (Performance & Live Trigger)
- **樂器指定功能對齊**：
  - 將 \sb_play_note\ (演奏持續音) 與 \sb_stop_note\ (停止持續音) 由 JSON 定義改為手動定義，並加入樂器動態選單。
  - 這解決了在即時演奏時無法指定不同樂器的限制，並確保持續音的開啟與關閉能精確作用於特定樂器。
  - 將這兩個積木的顏色改為亮橘色 (#D35400)，與普通的編曲型演奏積木做出視覺區隔。
- **PC 鍵盤事件強化**：
  - 更新 \ui_key_event\ 積木，新增「按下 (Pressed) / 放開 (Released)」切換選單。
  - 修正 Java 產生器：現在代碼會依據選單設定，分別注入到 Processing 的 \oid keyPressed()\ 或 \oid keyReleased()\ 佔位符中。
  - 完善了即時演奏的「按多久、響多久」邏輯鏈，支援複雜的互動樂器設計。
- **核心產生器升級**：
  - 修改 \_core.js\ 的 \inish\ 函式，新增 \{{KEY_RELEASED_EVENT_PLACEHOLDER}}\ 處理邏輯。
  - 優化 i18n 訊息結構，確保繁體中文與英文在多選單積木中的語法流暢性。
- 調整了 sb_play_note 與 sb_stop_note 的產生器，使其支援指定樂器的持續音控制。
- 修正了 i18n 訊息，確保介面文字在多語系下的一致性。

- 強化了 sb_play_note 與 sb_stop_note 的音高輸入，現在同時支援 MIDI 編號與音名 (如 'C4')。
- 在 _core.js 中新增 Java 輔助函式 getMidi，統一處理各類音高格式轉換。

- 優化了演奏積木的 UI 排版，將音高與力度標籤直接與插槽綁定，避免文字錯位。
- 確保所有音訊產生器皆使用動態轉型機制 (getMidi, floatVal)。

- 全面重整所有具備樂器選單的積木 UI 排版 (演奏單音、播放和弦、播放旋律、音量、相位)。
- 採用「標籤與輸入緊密綁定」的拆分結構，解決了多語系下文字對齊錯位與堆疊問題。
- 同步更新 en.js 與 zh-hant.js 以支援新的拆分欄位標籤。
- 修正 sb_play_chord_by_name 產生器中的冗餘代碼與轉型邏輯。

- 補全了 toolbox.xml 中所有重整後積木的影子積木 (Shadow Blocks)，確保預設值顯示正常。

- 修正了步進音序器 (sb_rhythm_sequence) 的 UI 排版，統一採用拆分 Input 結構，確保參數順序與翻譯文字正確對齊。

- 實作了翻譯鍵值的原子化拆分 (Atomic Translation Keys)，徹底移除了積木定義中脆弱的 split() 邏輯。
- 這確保了所有語系下的積木排版都能精確對齊，不再受翻譯語序或字元長度影響。

- 修正了滑鼠將積木拉出 Webview 邊界後導致的拖曳失常行為。
- 參考 #piBlockly 實作了 window 'blur' 事件監聽器，當視窗失去焦點且處於拖曳狀態時，強制呼叫 Blockly.Gesture.clearForced() 以釋放積木。

- 同時修正了 #SynthBlockly 專案中的 Webview 邊界拖曳失常行為，確保兩大專案的一致性。

- 實作了嚴格的「孤兒積木」限制機制。
- 只有帽子積木 (Hat Blocks) 與容器積木 (Containers) 允許放在工作區頂層，其餘積木若未接在正確流程中將自動失效並呈現灰色。
- 此機制已同步套用於 #SynthBlocklyStage 與 #SynthBlockly 兩大專案。

### Launchpad S 硬體整合與 MIDI 系統升級
- **MIDI 初始化升級**：將 \midi_init\ 積木由單一裝置索引升級為支援獨立的輸入 (Input) 與輸出 (Output) 設定，解決了硬體掃描索引不一致導致無法控制燈光的問題。
- **MIDI 傳送功能實作**：
    - 新增 \midi_send_note\ 積木：支援向硬體傳送 Note On/Off 訊號，用於控制 Launchpad 的 LED 燈光顏色。
    - 新增 \midi_send_cc\ 積木：支援傳送 MIDI 控制變更訊號。
- **Launchpad 輔助工具**：
    - 實作 \midi_lp_xy_to_note\ 積木：內建 \Note = Y * 16 + X\ 公式，並明確定義 (0,0) 為左上角，簡化了 8x8 網格按鈕的定位邏輯。
- **教學與範例系統**：
    - 建立 \media/docs/launchpad/開發手冊.html\：從官方文件擷取通訊協定、顏色代碼與佈局規格。
    - 建立 \launchpad_zh-hant.html\ / \en.html\：整合進積木說明系統 (helpUrl)，支援右鍵查看。
    - 實作 \ex_92_LaunchPad.xml\：完整展示了 8 個 Pad 的電子鼓觸發、Bossa Nova 和弦演奏以及即時燈光回饋邏輯。
- **UI 視覺優化**：修正了 Toolbox 中 MIDI 與視覺繪圖分類下的積木間距 (gap) 不一致問題，提升介面整潔度。

### MIDI 系統多裝置架構升級與 Launchpad S 深度整合
- **核心架構升級**：
    - 實作「命名裝置 (Named Busses)」系統，支援透過自訂名稱 (如 Keyboard, LaunchPad) 區分多個 MIDI 實體。
    - 升級 \midi_init\ 支援獨立的輸入 (Input) 與輸出 (Output) 索引設定。
    - 在 \_core.js\ 實作智慧型 Fallback 轉發邏輯，確保單一裝置時訊號自動路由。
- **積木功能擴充**：
    - 新增 \midi_send_note\、\midi_send_cc\ 積木，支援控制硬體 LED 燈光與參數反饋。
    - 實作 \midi_lp_xy_to_note\ 工具積木，簡化 8x8 網格座標 (0,0) 到 MIDI 鍵號的轉換。
    - 優化 MIDI 帽子積木排版：採用「三行佈局」 (標題/參數/凹槽)，提升複雜專案的閱讀性。
- **動態選單優化**：
    - 為所有樂器選擇欄位新增「當前選用的樂器」選項，並將其設為預設值。
    - 實作 \getInstrumentJavaName\ 產生器輔助函式，自動處理翻譯字串與 Java 變數 (\currentInstrument\) 的映射。
- **舞台互動增強**：
    - 在 \isual_stage_setup\ 加入 \equestFocus\ 邏輯，程式執行後 Processing 視窗會自動置頂並嘗試取得鍵盤焦點。
- **穩定性修復**：
    - 修正了 XML 載入時因參數數量 (Placeholder) 不匹配導致的崩潰。
    - 修正了 \_core.js\ 在處理 MIDI 事件陣列時的 \TypeError\。
    - 移除了 \isual_stage_setup\ 中重複的 MIDI 初始化，解決了雙倍 Log 與音效觸發的問題。
    - 修正 \sb_log_to_screen\ 下拉選單值與 XML 不相容的錯誤。
