# 2026-01-31 工作日誌

## 本日工作重點
修復了樂器定義容器化過程中的關鍵架構問題與語法錯誤，並大幅擴充了序列埠與視覺繪圖積木，強化超級舞台的互動性。

### 1. 影音同步架構修復 (關鍵更新)
- **樂器定義 setup 化**：修復了樂器定義積木在全域執行無效的問題。現在 `sb_instrument_container` 會強制將內部設定（`instrumentMap`, `instrumentADSR`）注入 `setup()` 函式。
- **ADSR 即時連動**：實作了 `updateInstrumentUISync()`。現在切換樂器（透過積木或左右方向鍵）時，舞台 UI 會自動更新為該樂器的參數；同時，手動調整 UI 參數也會在切換前自動存入資料庫，實現雙向同步。
- **PC Key 效能優化**：引入 `pcKeysHeld` 集合，解決了電腦鍵盤按住不放時會連續觸發 `playNote` 的問題，現在長按按鍵能正確進入聲音的 Sustain 階段。

### 2. Serial 通訊功能擴充
- **新增積木**：`sb_serial_write`。
- **功能描述**：支援從舞台向 Arduino 發送資料（字串），實現影音舞台對實體裝置的反向控制。
- **對齊規範**：與既有序列埠積木風格統一，並已更新至工具箱。

### 3. 視覺繪圖積木與 UI 升級
- **新增幾何積木**：`visual_ellipse` (圓形/橢圓)、`visual_triangle` (三角形)。
- **座標變換系統**：新增 `visual_rotate`, `visual_translate`, `visual_scale` 以及最重要的 `visual_push_pop` (隔離變換)，大幅強化視覺創作能力。
- **UI 視覺對照**：在舞台的 `FG COLOR` 滑桿下方新增了**實體彩虹 HSB 色帶**，方便使用者直觀地選取視覺前景顏色。
- **精度控制**：將 ADSR 相關滑桿設定為小數點後兩位精度，支援以 0.01 為單位的平滑調整。

### 4. 系統穩定性修復
- **修正 Javascript 損壞**：解決了 `visual.js` 產生器中因編碼錯誤、未結束字串及損壞的 `</script>` 標籤導致的 Blockly 載入失敗。
- **Java 轉義優化**：處理了產生器產出 Java 程式碼時的字串轉義錯誤（如 `\n` 處理），確保產出的 `.pde` 檔案在 Processing 中編譯 100% 通過。

## 待辦事項
- [ ] 測試 `push_pop` 在多重循環繪圖下的效能表現。
- [ ] 增加更多數學輔助積木 (sin, cos, noise) 以支援複雜繪圖邏輯。
- [ ] 考慮加入 MIDI CC (Control Change) 的 UI 映射功能。