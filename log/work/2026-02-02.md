# 工作日誌 2026-02-02

## 本次完成任務
- [x] **MIDI CC 支援**：實作 `midi_on_controller_change` 積木與產生器。
- [x] **範例檔案保護**：
    - 修正 `extension.ts` 讓 `examples/` 資料夾下的 XML 不會被自動儲存。
    - 修正 `main.js` 讓前端 UI 在範例被修改時顯示正確狀態（非 "Saved"）。
- [x] **音訊引擎對齊 (Web -> Processing)**：
    - 實作 `samplerMap` 與 `samplerGainMap` 全域管理。
    - 將 `sb_load_sample` 升級為 `sb_drum_sampler` (下拉選單)。
    - 重構 `sb_rhythm_sequence` 產生器，支援和弦解析與延音符號。
- [x] **初始化邏輯修正**：
    - 解決 `sb_instrument_container` 代碼遺失導致的 NullPointerException。
    - 確保 `sb_tone_loop` 在 `setup()` 最後啟動。
- [x] **步進音序器 (Step Sequencer) 優化**：
    - 調整積木標籤順序：`樂器` -> `力度` -> `模式` -> `小節` -> `節奏`。
    - 同步 `en.js` 術語為 "Step Sequencer" 與 "Pattern"。
    - 整合 Roland TR-909 鼓組樣本至 `ex_03_Rock` 範例中。
- [x] **專案管理功能修正**：
    - 修正「另存新檔」邏輯，避免在覆寫現有專案時建立巢狀同名資料夾。
- [x] **新增預備拍 (Count-in) 功能**：
    - 實作 `sb_transport_count_in` 積木，支援獨立背景執行緒。
    - 實作旗標同步機制，讓所有演奏積木在預備拍結束後才開始。
    - 優化 `playClick` 音色，使用 Square 波形與 Sharp 包絡線達成擊打感。

## 關鍵異動檔案
- `media/blocks/audio.js`: 更新步進音序器定義、新增預備拍積木。
- `media/generators/audio.js`: 實作預備拍執行緒、優化發聲邏輯與初始化安全性。
- `media/zh-hant.js` / `media/en.js`: 同步音序器與預備拍的語句。
- `src/extension.ts`: 修正另存新檔的專案資料夾建立邏輯。
- `examples/ex_03_Rock/ex_03_Rock.xml`: 補上力度參數、新增 Rimshot 軌道。

## 待處理事項
- 測試更多複雜的 MIDI 映射場景。
- 確認 `sb_drum_sampler` 的 `CUSTOM` 路徑輸入功能。
